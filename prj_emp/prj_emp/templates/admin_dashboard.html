<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        h1 {
            text-align: center;
        }
        .button-container {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }
        .button-container button {
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            background-color: #007bff;
            color: #fff;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .button-container button:hover {
            background-color: #0056b3;
        }
        form {
            display: none;
            margin-bottom: 20px;
        }
        form label {
            display: block;
            margin-bottom: 5px;
        }
        form input[type="text"],
        form input[type="email"],
        form input[type="tel"],
        form select,
        form textarea {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }
        form input[type="submit"] {
            background-color: #007bff;
            color: #fff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        form input[type="submit"]:hover {
            background-color: #0056b3;
        }
        table {
            display: none;
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        table th {
            background-color: #f2f2f2;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin Dashboard</h1>
        
        <div class="button-container">
            <button onclick="toggleForm('employeeForm')">Add Employee/Manager</button>
            <button onclick="toggleForm('projectForm')">Add Project</button>
            <button onclick="viewEmployees()">View Employees</button>
            <button onclick="viewProjects()">View Projects</button>
            <button onclick="toggleForm('assignProjectForm')">Assign/Unassign Project</button>
            <button onclick="viewRequests()">Approve/Reject Requests</button>
            <button onclick="toggleDeleteEmployee()">Delete Employee</button>
            <button onclick="toggleForm('updateEmployeeForm')">Update Employee</button>
        </div>

        <!-- Add Employee Form -->
        <section id="addEmployee">
            <form id="employeeForm" action="{% url 'admin_dashboard' %}" method="post">
                {% csrf_token %}
                {{ employee_form.as_p }}
                <button type="submit" name="employee_form_submit">Submit</button>
            </form> 
        </section>
        {% if messages %}
            <ul class="messages">
                {% for message in messages %}
                    <li>{{ message }}</li>
                {% endfor %}
            </ul>
        {% endif %}

        <!-- Add Project Form -->
        <section id="addProject">
            <form id="projectForm" action="{% url 'admin_dashboard' %}" method="post">
                {% csrf_token %}
                {{ project_form.as_p }}
                <button type="submit" name="project_form_submit">Add Project</button>
            </form>
        </section>

        <!-- View Employees -->
        <section id="viewEmployees">
            <table id="employeeTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Role</th>
                        <th>Skills</th>
                    </tr>
                </thead>
                <tbody id="employeeTableBody">
                    <!-- Employee data will be populated here -->
                </tbody>
            </table>
        </section>

        <!-- View Projects -->
        <section id="viewProjects">
            <table id="projectTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Project Manager</th>
                        <th>Project Skills</th>
                    </tr>
                </thead>
                <tbody id="projectTableBody">
                    <!-- Project data will be populated here -->
                </tbody>
            </table>
        </section>

        
        <section id="assignProject">
            <form id="assignProjectForm" action="{% url 'assign_project' %}" method="post">
                {% csrf_token %}
                <label for="project">Select Project:</label>
                <select name="project" id="projectSelect">
                    <!-- Options will be populated dynamically -->
                </select>
                <label for="employee">Select Employee:</label>
                <select name="employee" id="employeeSelect">
                    <!-- Options will be populated dynamically -->
                </select>
                <button type="button" onclick="assignProject()">Assign Project</button>
                <button type="button" onclick="unassignProject()">Unssign Project</button>
            </form>
        </section>

        <!-- Approve/Reject Managers' Requests -->
        <section id="viewRequests">
            <table id="requestTable">
                <thead>
                    <tr>
                        <th>Req ID</th>
                        <th>Manager ID</th>
                        <th>Project ID</th>
                        <th>Skills</th>
                        <th>Status</th>
                        <th>Employee IDs</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="requestTableBody">
                    <!-- Request data will be populated here -->
                </tbody>
            </table>
            
        </section>
        <!-- Delete Employee -->
        <section id="deleteEmployee" style="display: none;">
            <section id="deleteEmployee">
                <h2>Delete Employee</h2>
                <p>Enter the ID of the employee you want to delete:</p>
                <input type="text" id="employeeIdToDelete" placeholder="Employee ID">
                <button onclick="deleteEmployee()">Delete</button>
            </section>
        </section>

        <!-- Update Employee Details -->    
        <section id="updateEmployee">
            <form id="updateEmployeeForm">
                {% csrf_token %}
                <label for="employeeId">Select Employee to Update:</label>
                <select name="employeeId" id="updateEmployeeSelect" onchange="fetchEmployeeDetails(this.value)">
                    <option value="">Select Employee</option>
                    {% for employee in employees %}
                        <option value="{{ employee.id }}">{{ employee.id }} - {{ employee.name }}</option>
                    {% endfor %}
                </select>
                <div id="updateEmployeeFields">
                    <!-- Employee details fields will be populated here dynamically -->
                    <label for="name">Name:</label>
                    <input type="text" name="name" id="name" required>
                    <label for="email">Email:</label>
                    <input type="email" name="email" id="email" required>
                    <label for="phone">Phone:</label>
                    <input type="tel" name="phone" id="phone" required>
                    <label for="role">Role:</label>
                    <select name="role" id="role">
                        <option value="Employee">Employee</option>
                        <option value="Manager">Manager</option>
                    </select>
                    <label for="skills">Skills:</label>
                    <textarea name="skills" id="skills" required></textarea>
                </div>
                <button type="button" onclick="updateEmployee()">Update Employee</button>
            </form>
        </section>
    </div>

    <script>
        function toggleForm(formId) {
            console.log("Toggling form with ID:", formId);
            var forms = document.querySelectorAll('form, table');
            forms.forEach(function(form) {
                form.style.display = form.id === formId ? 'block' : 'none';
            });
            if (formId !== "requestsTable" && formId !== "approveRejectRequestsForm") {
                document.getElementById("requestsTable").style.display = "none";
                document.getElementById("approveRejectRequestsForm").style.display = "none";
            }
            if (formId !== "assignProjectForm") {
                document.getElementById("assignProjectForm").style.display = "none";
            }
                        
        }

        function viewEmployees() {
            document.getElementById("employeeTable").style.display = "block";
            document.getElementById("employeeForm").style.display = "none";
            document.getElementById("projectForm").style.display = "none";
            document.getElementById("projectTable").style.display = "none";
            document.getElementById("requestTable").style.display = "none";
            document.getElementById("assignProjectForm").style.display = "none";

            var table = document.getElementById("employeeTable");
            table.style.display = "block";

            var tableBody = document.getElementById("employeeTableBody");

            fetch('/api/employees/')
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = ''; 

                    data.forEach(employee => {
                        var row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${employee.id}</td>
                            <td>${employee.name}</td>
                            <td>${employee.email}</td>
                            <td>${employee.phone}</td>
                            <td>${employee.role}</td>
                            <td>${employee.skills}</td>

                    `;
                    tableBody.appendChild(row);
                    });
            })
            .catch(error => console.error('Error fetching employee data:', error));
        }
        function viewProjects() {
            document.getElementById("projectTable").style.display = "block";
            document.getElementById("employeeForm").style.display = "none";
            document.getElementById("projectForm").style.display = "none";
            document.getElementById("employeeTable").style.display = "none";
            document.getElementById("assignProjectForm").style.display = "none";
            document.getElementById("requestTable").style.display = "none";

            var table = document.getElementById("projectTable");
            table.style.display = "block";

            var tableBody = document.getElementById("projectTableBody");

            fetch('/api/projects/')
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = ''; 

                    data.forEach(project => {
                        var row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${project.id}</td>
                            <td>${project.name}</td>
                            <td>${project.description}</td>
                            <td>${project.start_date}</td>
                            <td>${project.end_date}</td>
                            <td>${project.project_manager}</td>
                            <td>${project.project_skills}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error fetching project data:', error));
        }
        function fetchAssignmentData() {        
            fetch('/api/projects/')
                .then(handleResponse)
                .then(projects => {
                    const projectSelect = document.getElementById("projectSelect");
                    projectSelect.innerHTML = ''; 
                    projects.forEach(project => {
                        const option = document.createElement("option");
                        option.value = project.id;
                        option.text = project.id; 
                        projectSelect.appendChild(option);
                    });
                })
                .catch(handleError);

            fetch('/api/employees/')
                .then(handleResponse)
                .then(employees => {
                    const employeeSelect = document.getElementById("employeeSelect");
                    employeeSelect.innerHTML = ''; 
                    employees.forEach(employee => {
                        const option = document.createElement("option");
                        option.value = employee.id;
                        option.text = employee.id; 
                        employeeSelect.appendChild(option);
                    });
                })
                .catch(handleError);
        }

        function assignProject() {
            const projectId = document.getElementById("projectSelect").value;
            const employeeId = document.getElementById("employeeSelect").value;

            if (!projectId || !employeeId) {
                alert("Please select both a project and an employee.");
                return;
            }
            fetch('/assign_project/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({ project: projectId, employee: employeeId }),
            })
            .then(handleResponse)
            .then(response => {
                alert(response.message);
                console.log('Project assigned to employee successfully');
            })
            .catch(handleError);
        }

        function unassignProject() {
            const employeeId = document.getElementById("employeeSelect").value;

            if (!employeeId) {
                alert("Please select an employee.");
                return;
            }
            fetch('/unassign_project/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({ employee: employeeId }),
            })
            .then(handleResponse)
            .then(response => {
                alert(response.message);
                console.log('Project unassigned from employee successfully');
            })
            .catch(handleError);
        }

        function handleResponse(response) {
            if (!response.ok) {
                throw new Error('Failed to perform action.');
            }
            return response.json();
        }

        function handleError(error) {
            console.error('Error:', error);
            alert('Failed to perform action. Please try again.');
        }

        function getCSRFToken() {
            let cookieValue = null;
            const name = 'csrftoken';
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        window.onload = fetchAssignmentData;
        function viewRequests() {
            document.getElementById("requestTable").style.display = "block";
            document.getElementById("employeeForm").style.display = "none";
            document.getElementById("projectForm").style.display = "none";
            document.getElementById("employeeTable").style.display = "none";
            document.getElementById("projectTable").style.display = "none";
            document.getElementById("assignProjectForm").style.display = "none";

            var tableBody = document.getElementById("requestTableBody");

            fetch('/api/requests/')
                .then(response => response.json())
                .then(data => {
                    tableBody.innerHTML = ''; 

                    data.forEach(request => {
                        var row = document.createElement("tr");
                        row.innerHTML = `
                            <td>${request.id}</td>
                            <td>${request.manager_id}</td>
                            <td>${request.project_id}</td>
                            <td>${request.skills}</td>
                            <td>${request.status}</td>
                            <td>${request.employee_ids.join(', ')}</td>
                            <td>
                                <button onclick="approveRequest(${request.id})">Approve</button>
                                <button onclick="rejectRequest(${request.id})">Reject</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error fetching request data:', error));
        }

        function approveRequest(requestId) {
            fetch(`/api/requests/${requestId}/approve/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    fetch(`/api/requests/${requestId}/employees/`)
                        .then(response => response.json())
                        .then(employeeData => {
                            const employeeIds = employeeData.employee_ids;
                            const projectId = data.project_id;

                            employeeIds.forEach(employeeId => {
                                fetch('/api/employeeproject/', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'X-CSRFToken': '{{ csrf_token }}'
                                    },
                                    body: JSON.stringify({ project_id: projectId, employee_id: employeeId })
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.message) {
                                        console.log(`Employee ID: ${employeeId} assigned to Project ID: ${projectId}`);
                                    } else if (data.error) {
                                        console.error(`Error assigning Employee ID: ${employeeId} to Project ID: ${projectId} - ${data.error}`);
                                    }
                                })
                                .catch(error => console.error('Error creating EmployeeProject record:', error));
                            });
                        })
                        .catch(error => console.error('Error fetching employee data:', error));
                    viewRequests();
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => console.error('Error approving request:', error));
        }

        function rejectRequest(requestId) {
            fetch(`/api/requests/${requestId}/reject/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                    viewRequests();
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => console.error('Error rejecting request:', error));
        }

        function deleteEmployee() {
            var employeeId = document.getElementById("employeeIdToDelete").value;

            if (!employeeId) {
                alert("Please enter the employee ID.");
                return;
            }

            if (!confirm("Are you sure you want to delete this employee?")) {
                return;
            }

            fetch(`/api/employees/${employeeId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(), 
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    alert(data.message);
                } else if (data.error) {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting employee:', error);
                alert('Failed to delete employee. Please try again.');
            });
        }
        function toggleDeleteEmployee() {
            var deleteEmployeeSection = document.getElementById("deleteEmployee");
            if (deleteEmployeeSection.style.display === "none") {
                deleteEmployeeSection.style.display = "block";
            } else {
                deleteEmployeeSection.style.display = "none";
            }
        }
        function fetchEmployeeDetails(employeeId) {
            if (!employeeId) return;

            fetch(`/get_employee_details/${employeeId}/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("name").value = data.name;
                    document.getElementById("email").value = data.email;
                    document.getElementById("phone").value = data.phone;
                    document.getElementById("role").value = data.role;
                    document.getElementById("skills").value = data.skills;
                    
                })
                
                .catch(error => console.error("Error fetching employee details:", error));
        }

        function updateEmployee() {
            const employeeId = document.getElementById("updateEmployeeSelect").value;
            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
            const phone = document.getElementById("phone").value;
            const role = document.getElementById("role").value;
            const skills = document.getElementById("skills").value;

            if (!employeeId) {
                alert("Please select an employee to update.");
                return;
            }

            fetch(`/admin_dashboard/update_employee/${employeeId}/`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken(),
                },
                body: JSON.stringify({ name, email, phone, role, skills }),
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                console.log('Employee details updated successfully');
            })
            .catch(error => {
                console.error("Error updating employee details:", error);
                alert("An error occurred while updating employee details.");
            });
        }  
    </script>
</body>
</html>
